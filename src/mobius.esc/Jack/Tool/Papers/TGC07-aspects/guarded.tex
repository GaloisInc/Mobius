To make the weaving lighter than the weaving done by {\tt ajc}, 
the model of the aspect  will be weaved. Therefore we need a form
for the bytecode that can handle directly the weaving of the model.
For this purpose we use a guarded command language. The language of 
choice is BoogiePL, because work has been done on the bytecode level for it.
There is a formal definition of Java bytecode translation to BoogiePL 
\cite{LehnerM07} as well as existing implementations of the translation
\cite{javatrans07,coqtrans06}. The base program code is transformed, as well
as the advices code.

\vspace{-0.4cm}
\subsubsection{Description of the language} 
The version of the language we use is the same set of instruction
described for weakest precondition on bytecode in \cite{BarnettL05}.
The full language described in \cite{DeLineL05} is not necessary
since our approach operates on bytecode.
It has 5 commands: {\tt assume}, {\tt assert}, {\tt assign}, {\tt
skip}, {\tt havoc}, {\tt goto} and label expressions.  The first four
commands are standard. {\tt havoc} is used to assign an arbitrary to a
variable, typically after a method call when a variable was modified
by it.  The {\tt goto} command determines an unconditionnal jump to
several labels.

\vspace{-0.4cm}
\subsubsection{BML inclusion}
The inclusion of BML annotations to BoogiePL has been described in 
\cite{javatrans07}, and is straightforward since BoogiePL has already 
assert and assume statements which are used in BML.  BoogiePL also
permits annotation of methods with requires, ensures as well as frame
conditions.  The two annotation constructs that are introduced for
this paper and are not yet described are the model methods and the
model method's calls and the aspect specific construct {\tt proceed}.

The model methods are methods that are only defined with their
specifications and on which we allow call within the
specifications. Their effects on the program is only represented by
their specifications. In BoogiePL one can generate procedure which 
does not contain implementation which would match exactly this behaviour.
The model methods calls within specification would be replaced by a
{\tt call} command withing BoogiePL methods' body.

The proceed is a predicate that can be called at any time in the program.
In BoogiePL it is easily represented by a variable {\tt proceed} 
of type {\tt bool}.

\subsubsection{Translating the Security Manager}
For the Security Manager, the guarded command translation is easy, but
the number of lines grow (5 lines at the bytecode version and 27 for
guarded command version) as shown for the base program on Figure~\ref{prog_gc}.
Nevertheless the aspects would have to be transformed into guarded
commands too. The model Security Manager is kept unchanged.




\vspace{-0.4cm}
%\bcode
%st\=art:\+\\
%    (New b.A) \\
%    (Invokespecial b.A.$<$init$>$)\\
%\< end:\\
%    (Return)
%\ecode
\begin{figure}[h]
\begin{center}
\begin{tabular}{ll} \begin{minipage}{3cm}
\bcode
ini\=t: \+\\ // initialization of the method\\
    old\_heap := heap; \\
    reg0 := \#0;\\
    assume requires(main, (old\_heap, \#0)); // true\\
\<start:\\
    // beginning of the program\\
    heap := add(heap, b.A);  // new call\\
    stack[0] := new(heap, b.A);\\
%(Invokevirtual java\_lang\_Class.getPackage) 
    arg0 := stack[0]; // constructor call \\
    pre\_heap := heap;\\
    assert arg0 != null;\\
    assert requires(b.A.$<$init$>$, pre\_heap, arg0);\\
    havoc heap;\\
    goto b.A.$<$init$>$\_normal, b.A.$<$init$>$\_excp;\\
\< b.A.$<$init$>$\_excp:\\
    havoc stack[0]\\
    assume alloc (stack[0], heap) $\wedge$ typeof(stack[0]) $<$: Throwable;\\
    assume exsures(b.A.$<$init$>$, (pre\_heap, arg0), (heap, stack[0]));\\
    goto handler;\\
\< b.A.$<$init$>$\_normal:\\
    havoc stack[0];\\
    assume ensures(b.A.$<$init$>$, (pre\_heap, arg0), (heap, stack[0]));\\
\< post: // post condition and exception handler\\
    assert ensures(main, (old\_heap, \= \#0), (heap, stack[0]));\\
\>// s.contains("b") \\
    goto;\\
\< handler:\\
    assert exsures(main, (old\_heap, \=\#0), (heap, stack[0])); \\
\>// !s.contains("b");\\
    goto;\\
\ecode
\end{minipage}
\end{tabular}
\end{center}
\vspace{-0.4cm}
\caption{The guarded command version of the base program}
\label{prog_gc}
\vspace{-0.4cm}
\end{figure}
\vspace{-0.6cm}
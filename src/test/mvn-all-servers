#/bin/bash
#
# This script runs on the Continuum server in place of Maven
#
# Distribution script for remote testing with Maven
# This script sits on a Continuum server and runs in place of the 'mvn' command
# e.g. ln -sf <this-script> /opt/local/bin/mvn
# see https://mobius.ucd.ie/wiki/ParallelTesting
#
#
# 1.1 Setup hardlinks to the working directory with latest checkout
export WORKDIR = $PWD
echo "export ESCTOOLS_ROOT="$PWD > Makefile.local
make pre-maven
rdiff-backup $WORKDIR ~/arrow/working-directory
rdiff-backup $WORKDIR ~/object/working-directory
#
# 1.2. Update local test scripts and authprogs.conf
#
./test/self_update.sh
ssh maven@athena.insttech.washington.edu ./test/self_update.sh
ssh maven@boomer.insttech.washington.edu ./test/self_update.sh
#
# 2. Run the Maven test suites concurrently
#
ssh maven@object.ucd.ie ./test/object.sh $* &
ssh maven@athena.insttech.washington.edu ./test/run_test.sh $* &
ssh maven@boomer.insttech.washington.edu ./test/run_test.sh $* &
ssh maven@arrow.ucd.ie ./test/arrow.sh $* &
wait;wait;wait;wait
#
# 3. Collect the test reports for viewing by Continuum
#
rdiff-backup ~/arrow/working-directory/target/site ./target/site
rdiff-backup ~/arrow/working-directory/target/surefire-reports/ $WORK_DIR/target/surefire-reports/arrow
rdiff-backup ~/object/working-directory/target/surefire-reports/TEST-DistributedTest.xml $WORK_DIR/target/surefire-reports/TEST-Object.xml
rdiff-backup maven@athena.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORK_DIR/target/surefire-reports/TEST-athena.insttech.washington.edu.xml
rdiff-backup maven@boomer.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORK_DIR/target/surefire-reports/TEST-boomer.insttech.washington.edu.xml
#/bin/bash
#
# This script runs a the Continuum server in place of the Maven executable
#
# Mobius - Distributed Testing Subsystem - Version 0.1 - April 2008
# Copyright (c) 2008, University College Dublin and Washington University
# License: GNU Public License (GPL), which is the default license for Mobius
# Homepage: https://mobius.ucd.ie/wiki/ParallelTesting
#
# Authors: Daniel M. Zimmerman, Dermot Cochran and Joseph R. Kiniry
#
# TODO: Have server names, details and topology in a configuration file
#
# Distribution script for remote testing with Maven
# This script sits on a Continuum server and runs in place of the 'mvn' command
# e.g. ln -sf <this-script> /opt/local/bin/mvn
# see https://mobius.ucd.ie/wiki/ParallelTesting
#
#
# 1.1 Setup hardlinks to the working directory with latest checkout
export WORKDIR=$PWD
echo "export ESCTOOLS_ROOT="$WORKDIR > Makefile.local
nice make pre-maven
nice cp -lr $WORKDIR/* ~maven/arrow/working-directory
nice cp -lr $WORKDIR/* ~maven/object/working-directory
nice cp -lr $WORKDIR/* ~maven/voting/working-directory
nice cp -lr $WORKDIR/* ~maven/category/working-directory

#
# 1.2. Update local test scripts and authprogs.conf
#
ssh maven@arrow.ucd.ie ./test/self_update.sh
ssh maven@athena.insttech.washington.edu ./test/self_update.sh
ssh maven@boomer.insttech.washington.edu ./test/self_update.sh
#
# 2. Run the Maven test suites concurrently
#
ssh maven@object.ucd.ie ./test/object.sh -U $* &
ssh maven@athena.insttech.washington.edu ./test/run_test.sh -U $* &
ssh maven@boomer.insttech.washington.edu ./test/run_test.sh -U $* &
ssh maven@category.ucd.ie ./test/category.sh -U $* &
ssh maven@voting.ucd.ie ./test/voting.sh -U $* &
ssh maven@arrow.ucd.ie ./test/arrow.sh -U $* &
wait;wait;wait;wait;wait;wait
#
# 3. Collect the test reports for viewing by Continuum
#
nice cp -lr ~/arrow/working-directory/target/site $WORKDIR/target/site
nice cp -lr ~/arrow/working-directory/target/surefire-reports/ $WORKDIR/target/surefire-reports/arrow
nice cp -l ~/object/working-directory/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-Object.xml
nice rsync maven@athena.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-athena.insttech.washington.edu.xml
nice rsync maven@boomer.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-boomer.insttech.washington.edu.xml
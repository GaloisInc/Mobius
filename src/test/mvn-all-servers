#/bin/bash
#
# This script runs a the Continuum server in place of the Maven executable
#
# Mobius - Distributed Testing Subsystem - Version 0.1 - April 2008
# Copyright (c) 2008, University College Dublin and Washington University
# License: GNU Public License (GPL), which is the default license for Mobius
# Homepage: https://mobius.ucd.ie/wiki/ParallelTesting
#
# Authors: Daniel M. Zimmerman, Dermot Cochran and Joseph R. Kiniry
#
# TODO: Have server names, details and topology in a configuration file
#
# Distribution script for remote testing with Maven
# This script sits on a Continuum server and runs in place of the 'mvn' command
# e.g. ln -sf <this-script> /opt/local/bin/mvn
# see https://mobius.ucd.ie/wiki/ParallelTesting
#
#
# 1.1 Setup hardlinks to the working directory with latest checkout
export WORKDIR=$PWD
echo "export ESCTOOLS_ROOT="$WORKDIR > Makefile.local
make pre-maven
rdiff-backup $WORKDIR ~/arrow/working-directory
rdiff-backup $WORKDIR ~/object/working-directory
rdiff-backup $WORKDIR ~/voting/working-directory
rdiff-backup $WORKDIR ~/category/working-directory

#
# 1.2. Update local test scripts and authprogs.conf
#
cd /Network/Servers/kind.ucd.ie/Volumes/Home/maven
./test/self_update.sh
ssh maven@athena.insttech.washington.edu ./test/self_update.sh
ssh maven@boomer.insttech.washington.edu ./test/self_update.sh
#
# 2. Run the Maven test suites concurrently
#
ssh maven@object.ucd.ie ./test/object.sh $* &
ssh maven@athena.insttech.washington.edu ./test/run_test.sh $* &
ssh maven@boomer.insttech.washington.edu ./test/run_test.sh $* &
ssh maven@category.ucd.ie ./test/category.sh $* &
ssh maven@voting.ucd.ie ./test/voting.sh $* &
ssh maven@arrow.ucd.ie ./test/arrow.sh $* &
wait;wait;wait;wait;wait;wait
#
# 3. Collect the test reports for viewing by Continuum
#
rdiff-backup ~/arrow/working-directory/target/site ./target/site
rdiff-backup ~/arrow/working-directory/target/surefire-reports/ $WORKDIR/target/surefire-reports/arrow
cp -f ~/object/working-directory/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-Object.xml
rsync maven@athena.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-athena.insttech.washington.edu.xml
rsync-backup maven@boomer.insttech.washington.edu:./ESCTools/target/surefire-reports/TEST-DistributedTest.xml $WORKDIR/target/surefire-reports/TEST-boomer.insttech.washington.edu.xml
\subsection{Weakest precondition predicate transformer for expressions}\label{pog:wpSrc:wpExpr}
In the following, we  give a  definition of a weakest
precondition predicate transformer function for source expressions.

 %The weakest precondition function for expressions has the following signature:
%$$ \wpNameSrcExpr : \expressionSrc \rightarrow \formulaSrc \rightarrow ( \mbox{ \rm \texttt{Exc}} \rightarrow  \formulaSrc ) \rightarrow  
%\MethodSet \rightarrow   (\expressionSpecSrc \cup \formulaSrc)  \rightarrow  \formulaSrc $$
For calculating the  $\wpNameSrcExpr$ \ predicate  of  an expression $\expressionSrc$ declared in method \methodd,
 the function $\wpNameSrcExpr$ \ takes as arguments  $\expressionSrc$, a postcondition $\normalPostSrc$, an exceptional postcondition 
function $\excPostSrc$  and  returns the    formula $\wpSrcExpr{\expressionSrc}{\psi}{\excPostSrc}{ v }$ which is the \wpName \ precondition of expression $\expressionSrc$ 
if its evaluation is stored in the special logical variable $v$. 



In Fig. \ref{pog:wpSrc:wpExpr:wpSrcExpr} we can see the $\wpNameSrcExpr$ rules for  most of the expressions of the source language (except for method invocation 
and instance creation). As we may notice, for some of the expressions   
the definition of the weakest precondition function is the identity function
 as their evaluation always terminates normally. For instance, the rule for constant expressions does not change the state and thus,
 if a predicate $ \normalPostSrc$ holds
 after its execution this means that it held in the prestate of the expression. 
 However, this is not the case for expressions that might throw an exception. % or which may change values of program variables.
 The predicate returned by the weakest precondition predicate transformer for expressions which may throw an exception 
will basically accumulate the hypothesis under which the evaluation 
of the expression terminates normally and the  conditions under which it  terminates exceptionally.
 For instance, the rule for a cast expression $( \class ) \ \expressionSrc$ shows that the evaluation of the expression
does not change the program state in case the $ \expressionSrc$ is of subtype of of class  $\class$. In case the latter is not true 
the rule reflects the case that the a  \ClassCastExc{} exception is thrown.
Note that in the exceptional case, we specify  that the thrown exception object is any  fresh exception object w.r.t.  the heap in the previous step via the 
predicate \instances{} whose semantics is that an object  belongs to the heap in the previous state.
 Similarly, the rule for the field access expression takes into account
the two possible  outcomes of its evaluation. If the evaluation $v$ of the expression $\expressionSrc$ 
is different from $\Mynull$ then the evaluation terminates normally, otherwise the exceptional postcondition  
for \NullPointerExc{}  must hold.



\begin{figure}[ht!]
\begin{frameit}
$${\scriptsize 
        \begin{array}{l} 
           \wpSrcExpr{const}{\normalPostSrc }{ \excPostSrc }{v}  =  \normalPostSrc\subst{v}{const}  \\ 
	   const \in \{  \constantInt ,   \Mynull, \this,\var\} \\
	   \\\\
	   %\wpSrcExpr{\Mynull  }{\normalPostSrc }{ \excPostSrc }{\Mynull} =  \normalPostSrc \\ 
	    % \\
	   \wpSrcExpr{ \expressionSrc_1 \ \op \ \expressionSrc_2 }{\normalPostSrc }{ \excPostSrc }{v}  =   \\

	    \begin{array}{l}
                \wpSrcExpr{ \expressionSrc_1  }{\wpSrcExpr{\expressionSrc_2 }{ 
                \begin{array}{l}
	           v_2\neq \Mynull \Rightarrow \normalPostSrc \subst{v}{v_1 op v_2} \\
		   \wedge\\
		   v_2 = \Mynull \Rightarrow
		        \left( \begin{array}{l} 
							      \forall \freshVar, 
							      (\neg \instances(\freshVar) \wedge
							       \freshVar \neq \Mynull) \Rightarrow\\ 
							       \Myspace\excPostSrc(\ArithExc )\subst{\EXC}{\freshVar}
							  \end{array}\right)
		\end{array}
		 }{ \excPostSrc }{v_2}  }{ \excPostSrc }{v_1} 
	    \end{array}\\
	    where \ \op \in \{ \myDiv , \myRem  \}\\
	   \\\\
	   %\wpSrcExpr{\this  }{\normalPostSrc }{ \excPostSrc }{\this} = \normalPostSrc	      	    \\
	   %\\


		     
             \wpSrcExpr{\expressionSrc.\fieldd  }{\normalPostSrc }{ \excPostSrc }{v}  = \\
	                        \begin{array}{l} \wpSrcExpr{\expressionSrc }{%\\
			                  % \phantom{wpiSr} %\begin{array}{l} 
						        v_1 \neq \Mynull \Rightarrow \normalPostSrc \subst{v}{v_1.\fieldd} %\\
			                                \wedge %\\
						        v_1 = \Mynull \Rightarrow%\\
							 %\Myspace 
							 \left( \begin{array}{l} 
							      \forall \freshVar, 
							      (\neg \instances(\freshVar) \wedge
							       \freshVar \neq \Mynull) \Rightarrow\\ 
							       \Myspace\excPostSrc(\NullPointerExc )\subst{\EXC}{\freshVar}
							  \end{array}\right)
							        
		                                  % \end{array}
						   }{% \\ 
                                          % \phantom{wpiSrc}
					    \excPostSrc }{v_1}  
				\end{array}  \\
		 \\\\	
 

\wpSrcExpr{ ( \class ) \ \expressionSrc  }{\normalPostSrc }{ \excPostSrc }{v} = \\
	         \begin{array}{l}   \wpSrcExpr{ \expressionSrc } { %\\ 
                      
                    % \phantom{wpSr} \begin{array}{l}

                    \typeof{v_1 } <:\class  \vee v_1 = \Mynull \Rightarrow   % \\

		      %\phantom{wpSr} \phantom{wpSr}  
		       \normalPostSrc \subst{v}{v_1}  %\\
		     \wedge \\
		   \phantom{wpSr\expressionSrc\neg} \neg \   \typeof{v_1 } <:  \class \Rightarrow  %\\ 
		    %\phantom{wpSr}
							 % \left( \begin{array}{l} 
							      \forall \freshVar, 
							      (\neg \instances(\freshVar) \wedge  % \\
							       \freshVar \neq \Mynull) \Rightarrow %\\ 
							       \excPostSrc( \mbox{ \rm \ClassCastExc }  ) \subst{\EXC}{\freshVar}
							  %\end{array}\right)
                     

                     %\end{array}  
                    } { %\\ 
		    %\phantom{wpSrc} 
                       \excPostSrc }{v_1} \end{array}
		    \\\\	
		    % \wpSrcExpr{ \expressionSrc \ \instanceofSrc \  \class }{\normalPostSrc  }{ \excPostSrc }{ v}= \\
	             %   \wpSrcExpr{ \expressionSrc  }
                     %             { \normalPostSrc\subst{v}{ v_1 \neq \Mynull \wedge \typeof{ v_1 } <:  \class }  }
		%		  { \excPostSrc }{v_1 } \\
                   % \\\\

           \wpSrcExpr{ \expressionSrc_1 \ \rel \ \expressionSrc_2 }{\normalPostSrc }{ \excPostSrc }{v} = \\
	       \begin{array}{l}
                       \wpSrcExpr{ \expressionSrc_1  }{  \wpSrcExpr{ \expressionSrc_2  }{ \normalPostSrc \subst{v}{v_1 \rel v_2 } }{ \excPostSrc }{v_2}  }{ \excPostSrc }{v_1}
               \end{array}\\ 


    \end{array} 
} $$

\caption{\sc WP for source expressions }
\label{pog:wpSrc:wpExpr:wpSrcExpr}
\end{frameit}
\end{figure}


In Fig.\ref{pog:wpSrc:wpExpr:wpSrcNew}, we give the rule of instance creation.  
Recall that the semantics of this 
construct is that a new instance of the corresponding class \class{} is created and the class constructor
which has the same name initializes the new reference.
%We can remark that we are using a contract based approach (see \cite{M97oos}) and thus, methods are supplied with preconditions, postconditions and frame conditions.
% A contract based approach uses specifications for 
%verifying methods and not method implementations. The specification of a method as stated earlier consists of a pre and postcondition.
%The method precondition expresses the part of the method contrtact which states what must \textit{hold} when the method is invoked.
%The method postcondition expresses the part of the method contract which states what the method \textit{guarantees} when the method 
%terminates execution. 
Class constructors in Java are also methods 
and thus, those are supplied with  
 precondition $\class.\preSrc$  and a postcondition $\class.\normalPostSrc$.
Thus, the  rule for instance creation states that in the state where the constructor of  $\class$  is invoked 
 its precondition  $\class.\preSrc $ holds and  in the state in which $\class$ 
 terminates execution its postcondition $\class.\normalPostSrc$ implies the postcondition $\normalPostSrc$  of 
the instance creation expression. Note that the implication is quantified over the newly created  instance which did not exist in the prestate
 of the instance creation expression and which is different from \Mynull. The fact that the instance is new for the heap
w.r.t. the previous execution states 
 is expressed  via the  predicate ($\neg \ \instances(\freshVar ) $). 
Moreover, the fields of the new instance, i.e. fields 
that are declared in any superclass of \class{}  or in \class ( $ \subtype{\fieldd.\declaredIn}{  \class} $) are set
 to their default values in the precondition of the constructor \class. This correspond to the Java semantics
of creating new instances in the heap, i.e. first the reference is created and its fields are set to their default values and then,
 the  constructor is invoked.
The rule for method invocation is given in Fig.\ref{pog:wpSrc:wpExpr:wpSrcInv} and is similar to the instance creation expression rule. 
In the case for method invocation, we may remark that a quantification is done over the result of the method invocation.  



% Let us now look at the rule for method invokation expression $ \expressionSrc.\methodd()$ in Fig. \ref{pog:wpSrc:wpExpr:wpSrcNew}.
%The resulting precondition  takes into account the case when the  object $v$ to which $\expressionSrc $ evaluates and
% on which  the method is called is \Mynull{} or not. If it is \Mynull{} then the weakest precondition of the handler against \NullPointerExc{}
%must hold. In the opposite case, we want several predicates to hold. 
%First, the precondition $ \methodd.\preSrc $  of the invoked method \methodd{} must hold. 
%Then, the  normal postcondition $\methodd.\normalPostSrc $ 
%of \methodd{} must imply the postcondition  $\normalPostSrc{}$ whatever is the value of the returned object and whatever are the values of the 
%locations in the modifies list $\methodd. \mod{}$  of the method \methodd. Finally, if the method \methodd{} terminates on an exception \mbox{\rm\texttt{E}},
% then the respective postcondition    $\methodd.\excPostSpecSrc(\mbox{\rm \texttt{E}})$ must imply the predicate $\excPostSrc(\mbox{\rm\texttt{E}} )$  returned by the exceptional function 
% $\excPostSrc$ whatever are the values of the locations in the modifies list  $\methodd. \mod{} $  of the method~\methodd.


\begin{figure}[ht!]
\begin{frameit}
$${\scriptsize 
        \begin{array}{l} 
	     

\wpSrcExpr{ \newSrc \ \class  (   ) } {\normalPostSrc }{ \excPostSrc  }{v} = \\
 	  
 	             \begin{array}{l}  \forall \freshVar, \\
 				               \neg \ \instances(\freshVar ) \wedge 
 					       \freshVar  \neq \Mynull  \wedge \typeof{\freshVar} = \class \Rightarrow \\ 
		     
 		                \left( \begin{array}{l}
                                   
 				     \class.\preSrc
 				          %\begin{array}{l} 
                                                \subst{ \this}{ \freshVar } %\\
                                		\subst{ \fieldd} { \update{\fieldd} { \freshVar}{\defaultValue{ \fieldd.  \fieldType } } }_{{ \subtype{\fieldd.\declaredIn}{  \class}} } 
  					        %\subst{\typeof{\freshVar}}{\class}\\
                                          %\end{array} \\
  				       \wedge \\
				 \left( \begin{array}{l} \forall \ x \in \class. \mod , \\
				     (\class.\normalPostSrc       
  					       %\begin{array}{l}   
  						     %\subst{ \this}{ \freshVar  } %\\
						     %\subst{ \fieldd} { \update{\fieldd} { \freshVar}{\defaultValue{ \fieldd.  \fieldType } } }_{{ \subtype{\fieldd.\declaredIn}{  \class}} } 
                                                     %\subst{\typeof{\freshVar}}{\class}
%\end{array}  

                                     \Rightarrow % \\  
						   \normalPostSrc) %\begin{array}{l}
						    \subst{ v }{ \freshVar  } 
						    %\subst{ \fieldd} { \update{\fieldd} { \freshVar}{\defaultValue{ \fieldd.  \fieldType } } }_{{\subtype{\fieldd.\declaredIn}{  \class}} }
                                                    %\subst{\typeof{\freshVar}}{\class} 
                                                  
%\end{array} 
\end{array}\right)\\
  					             \wedge \\
  						    \left(\begin{array}{l} \forall \mbox{\rm \texttt{Exc}} \in  \class.\exceptionSrc, 
  						   \forall \ x \in \class.\mod, 
  						    \forall \freshVar_{exc},\\
						 
						 (\freshVar \neq \Mynull \wedge
                                                  
						 \typeof{\freshVar_{exc}} <: \mbox{\rm\texttt{Exc}} \wedge %\\
						  \class.\excPostSpecSrc ( \mbox{\rm\texttt{Exc}})) 
                                                           \Rightarrow %\\
                                              \excPostSrc( \mbox{\rm\texttt{Exc}})
					 \end{array}\right) 
					 \begin{array}{l}
					   \subst{\EXC}{\freshVar_{exc}}%\\ 
					   \subst{ v }{ \freshVar  } %\\  
					   %\subst{ \fieldd}{\update{\fieldd} { \freshVar}{\defaultValue{ \fieldd.  \fieldType } } }_{{ \subtype{\fieldd.\declaredIn}{  \class}} }
					   \end{array}
  		              \end{array}\right)
			      \end{array}
  		     

        \end{array} } $$
\caption{\sc Weakest precondition for instance creation }
\label{pog:wpSrc:wpExpr:wpSrcNew}
\end{frameit}
\end{figure}


\begin{figure}[ht!]
\begin{frameit}
$${\scriptsize 
        \begin{array}{l} 
	     

\wpSrcExpr{ \expressionSrc.m() } {\normalPostSrc }{ \excPostSrc  }{v} = \\
 	  
\begin{array}{l}  
 	\wpSrcExpr{\expressionSrc} { \begin{array}{l} m.\preSrc \subst{ \this}{v_1} \\
	                                              \wedge\\
						      \left( \begin{array}{l} \forall \ x \in m. \mod , \forall \freshVar, \\
						         m.\normalPostSrc \subst{ \this}{v_1}\subst{\result}{\freshVar} \Rightarrow %\\
                                                            %\Myspace  
							    \normalPostSrc \subst{v}{\freshVar}
						     \end{array}\right) \\
						     \wedge\\
					 \left( \begin{array}{l}	     
					      \forall \mbox{\rm \texttt{Exc}} \in  m.\exceptionSrc,  \forall \ x \in m.\mod, \forall \freshVar_{exc},\\  
                                                % \freshVar_{exc} \neq \Mynull \wedge \\
						 (\typeof{\freshVar_{exc}} <: \mbox{\rm\texttt{Exc}} \wedge %\\
						  \class.\excPostSpecSrc ( \mbox{\rm\texttt{Exc}}) 
                                                   )        \Rightarrow %\\
                                     %\Myspace    
				     \excPostSrc( \mbox{\rm\texttt{Exc}})
					 \end{array}\right) \subst{\EXC}{\freshVar_{exc}}\\ 
					   
                                 \end{array}

       } { \excPostSrc}{v_1}
\end{array}\end{array}
} $$
\caption{\sc Weakest precondition for method invocation }
\label{pog:wpSrc:wpExpr:wpSrcInv}
\end{frameit}
\end{figure}







\newtheorem{substHeap}{Lemma}[section]
\newtheorem{newHeap}[substHeap]{Lemma}
\newtheorem{substStack}[substHeap]{Lemma}
\newtheorem{substCntr}[substHeap]{Lemma}
\newtheorem{substLv}[substHeap]{Lemma}
\newtheorem{substRet}[substHeap]{Lemma}


\newtheorem{valid}{Definition}[section]

\section{Substitution properties}\label{substProp}

The following lemmas estasblish that substitution over state configurations or expressions / formulas result in the same evaluation


\begin{substLv}[Update  a local variable]\label{substLv}
For any expressions $ \expressionsWp_1, \expressionsWp_2 $ 
if we have that the states $s_1$ and $s_2$ are such that
$ s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and 
$ s_2 =   \config{\heap}{\counterOnly }{ \stackOnly }{\update{\locVarOnly}{i}{ \evalExp{ \expressionsWp_2}{ s_1 } }}{\pc }  $ then 
the following holds:
\begin{enumerate}
      \item $\evalExp{\substitution{\expressionsWp_1}{ \locVar{i} }{ \expressionsWp_2 }}{ s_1 } = \evalExp{\expressionsWp_1}{s_2} $
      \item $\interp{\substitution{\psi}{ \locVar{i} }{ \expressionsWp_2 }}{ s_1 } \iff \interp{\psi}{s_2} $
\end{enumerate}
\end{substLv}
Proof : by structural induction on the structure of $\expressionsWp_1$ 
\begin{enumerate}
\item we look at the first part of the lemma concerning expression evaluation

\begin{itemize}
   \item    $ \expressionsWp_1 = \locVar{i} $ 
           $$
	    \begin{array}{l}
	          ( left ) \  \substitution{\locVar{i}  }{ \locVar{i} }{ \expressionsWp_2 }    = \expressionsWp_2 \\
		  \Rightarrow \\
		\numConclusion{1} \  \evalExp{\substitution { \locVar{i} }{ \locVar{i} }{ \expressionsWp_2 }}{ s_1 } =   \evalExp{\expressionsWp_2}{s_1} \\
		  \\
		  (right ) \  \evalExp{\locVar{i}}{s_2} = \\
		  \mbox{\rm\comment{by Def.\ref{interpExpr} of the evaluation  for local variables  }} \\
		\numConclusion{2} \  =  \evalExp{\expressionsWp_2}{s_1} \\
		 \mbox{\rm\comment{from \numConclusion{1} \  and \numConclusion{2} \ we get that the lemma holds in this case  }}
	    \end{array} 
	   $$
   \item $\expressionsWp_1 = \fieldAccess{\expressionsWp_3}{\fieldd}$
         $$\begin{array}{l} 
	      \substitution{\fieldAccess{\expressionsWp_3}{\fieldd}}{ \locVar{i} }{ \expressionsWp_2 } = \\
	      \mbox{\rm\comment{by definition of the substitution }} \\ 
	      = \fieldAccess{\substitution{\expressionsWp_3}{ \locVar{i} }{ \expressionsWp_2 } }{\fieldd} \\
	      
	      \mbox{\rm\comment{by induction hypothesis }} \\
	     	\numConclusion{1} \evalExp{\substitution{\expressionsWp_3}{ \locVar{i} }{ \expressionsWp_2 }}{ s_1 } = \evalExp{\expressionsWp_3}{s_2} \\
              \\
	      \mbox{\rm\comment{by  Def.\ref{interpExpr} of the evaluation  for field access expressions }} \\
	      ( left ) \  \evalExp{\substitution{\fieldAccess{\expressionsWp_3}{\fieldd  }}{ \locVar{i} }{ \expressionsWp_2 }}{s_1} = \\
	                = \heap(\fieldd)( \evalExp{\substitution{\expressionsWp_3}{ \locVar{i} }{ \expressionsWp_2 }}{s_1}   ) \\
	      \\
		
	       (right ) \   \evalExp{  \fieldAccess{\expressionsWp_3}{\fieldd} }{s_2} = \\
	                   = \heap(\fieldd) ( \evalExp{\expressionsWp_3 }{s_2}) \\
	      \\ 
              \mbox{\rm\textit{ \{ from \numConclusion{1},( left ) and    (right )}}\\
	      \mbox{\rm\textit{  we get that the lemma holds in this case \} }}
	      
	  \end{array} 
	 $$
    \item the rest of the cases proceed in a similar way by appluing the induction hypothesis
\end{itemize}

 \item second case of the lemma 
   \begin{itemize} 
            \item $ \psi = \exprWp' \  \predicates \  \exprWp' $
	    $$
	    \begin{array}{l} 
 \mbox{\rm\comment{from the first part of the lemma we get  }} \\
              	\numConclusion{1} \ \evalExp{\substitution{ \expressionsWp'}{ \locVar{i} }{ \expressionsWp_2 } }{s_1} =   \evalExp{\expressionsWp'}{s_2}\\
		 \numConclusion{2} \ \evalExp{\substitution{ \expressionsWp''}{ \locVar{i} }{ \expressionsWp_2 } }{s_1} =   \evalExp{\expressionsWp''}{s_2}\\
		 
\\
	    
               \interp{\substitution{\psi}{ \locVar{i} }{ \expressionsWp_2 }}{ s_1 }   \\
	      \mbox{\rm\comment{definition of substitution }} \\
	     \numConclusion{3}  \equiv \\
	       \interp{\substitution{ \expressionsWp'}{ \locVar{i} }{ \expressionsWp_2 } \  \predicates \ \substitution{ \expressionsWp'' }{ \locVar{i} }{ \expressionsWp_2 }  }{ s_1 }\\
	        \mbox{\rm\comment{by  Def.\ref{interpPred}  we get  }} \\
		\iff \\
		\evalExp{\substitution{ \expressionsWp'}{ \locVar{i} }{ \expressionsWp_2 } }{s_1}
                  \evalRel{\predicates }
		   \evalExp{ \substitution{ \expressionsWp'' }{ \locVar{i} }{ \expressionsWp_2 } }{s_1} \ is \ true \\
		
		\mbox{\rm\comment{from  \numConclusion{1} , \numConclusion{2} and   \numConclusion{3}    }} \\
		\iff \\
		\evalExp{\expressionsWp'}{s_2} \evalRel{\predicates } \evalExp{\expressionsWp''}{s_2} \\
		\equiv \\
		\interp{\psi}{s_2}
	      \end{array} 
	 $$
	 \item the rest of the cases are by structural induction
   \end{itemize}
\end{enumerate}

\begin{substHeap}[Update of the heap]\label{substHeap}
For any expressions $ \expressionsWp_1, \expressionsWp_2, \expressionsWp_3 $ and any field \fieldd
if we have that the states $s_1$ and $s_2$ are such that
 $s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and \\
  $s_2 =  \config{ \update{\heap}{\fieldd }{\update{\fieldd}
                                                   {\evalExp{\expressionsWp_2}{ s_1 } }
                                                   {\evalExp{ \expressionsWp_3}{ s_1 } } } }
                                          {\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }   $  the following holds
\begin{enumerate}
  \item $ \evalExp{\substitution{\expressionsWp_1}{\fieldd}{ \update{ \fieldd  }{\expressionsWp_2}{\expressionsWp_3} }}{ s_1 } =  \evalExp{\expressionsWp_1}{ s_2  }  $
  \item $ \interp{\substitution{\psi}{\fieldd}{ \update{ \fieldd  }{\expressionsWp_2}{\expressionsWp_3} }}{ s_1 } \iff  \interp{\psi}{ s_2  }  $
\end{enumerate}
\end{substHeap}

 \begin{newHeap}[Update of the heap with a newly allocated object]\label{newHeap}
For any expressions $ \expressionsWp_1$  
if we have that the states $s_1$ and $s_2$ are such that
 $s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and 
  $s_2 =  \config{\heap'}{\counterOnly}{ \update{\stackOnly}{\counterOnly}{\evalExp{\referenceOnly}{s_1}} }{\locVarOnly}{\pc } $ where
 $  \newRef{\heap}{\clazz} = (\heap', \referenceOnly)   $  the following holds
\begin{enumerate}
  \item \[ \begin{array}{l}   \evalExp{\expressionsWp_1 \begin{array}{l}
                             \subst{ \stack{\counter}}{ \referenceOnly} \\
			     \lbrack  \fieldd \leftarrow \update{\fieldd } { \referenceOnly }{\defaultValueOnly( \fieldd.  \fieldType ) }  
                             \rbrack_{ \forall \fieldd: \FieldSet, \subtype{ \fieldd.\declaredIn}{ \clazz} }
                             \end{array}}{s_1} \\
			     = \\
                            \evalExp{\expressionsWp_1}{ s_2  } 
			     \end{array}  \]

     \item \[\begin{array}{l}  \interp{\psi \begin{array}{l}
                              \subst{\stack{\counter}}{\referenceOnly }\\
 			      \subst{\fieldd }{ \update{\fieldd } { \referenceOnly }{\defaultValueOnly( \fieldd.\fieldType)}} _{  \forall \fieldd: \FieldSet, \subtype{ \fieldd.\declaredIn}{ \clazz}   }
                              \end{array}}{s_1}\\
 			      \iff \\ 
 			     \interp{\psi}{s_2} 
 			     \end{array}  \]
 
 
 \end{enumerate}
 \end{newHeap}




%Proof : by structural induction on the structure of $\expressionsWp_1$ 
%\begin{enumerate}
%\item we consider the first case of the lemma 
%\begin{itemize}
%	  
 %    \item $\expressionsWp_1 = \stack{\counter} $
%      
%      $$
%	    \begin{array}{l}
%	          ( left ) \  \substitution{\stack{\counter}  }{ \stack{\counter} }{ \referenceOnly }    = \referenceOnly \\
%		  \Rightarrow \\
%		\numConclusion{1} \  \evalExp{\substitution {\stack{\counter}  }{ \referenceOnly }{ \expressionsWp_2 }}{ s_1 } =   \evalExp{\referenceOnly}{s_1} \\
%		  \\
%		  (right ) \  \evalExp{\locVar{i}}{s_2} = \\
%		  \mbox{\rm\comment{by Def.\ref{interpExpr} of the evaluation  for local variables  }} \\
%		\numConclusion{2} \  =  \evalExp{\expressionsWp_2}{s_1} \\
%		 \mbox{\rm\comment{from \numConclusion{1} \  and \numConclusion{2} \ we get that the lemma holds in this case  }}
%	    \end{array} 
%	   $$

%\end{itemize}
%%\item by structural induction over the structure of the formula $\psi$
%\end{enumerate}

\begin{substStack}[Update the stack]\label{substStack} 
For any expressions $ \expressionsWp_1, \expressionsWp_2, \expressionsWp_3 $ 
if we have that the states $s_1$ and $s_2$ are such that
 $s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and 
  $s_2 = \config{\heap}{\counterOnly}{ \update{\stackOnly}
                                                                 {\evalExp{\expressionsWp_2}{ s_1 } }
                                                                 { \evalExp{\expressionsWp_3}{ s_1  } } }{\locVarOnly}{\pc }$ then
 the following holds:
\begin{enumerate}
      \item  $     \evalExp{\substitution{\expressionsWp_1}{\stack{\expressionsWp_2}}{\expressionsWp_3}}{s_1 } = 
      \evalExp{\expressionsWp_1}{s_2 }$
      \item  $     \interp{\substitution{\psi}{\stack{\expressionsWp_2}}{\expressionsWp_3}}{s_1 } \iff
      \interp{\psi}{s_2 }$
\end{enumerate}
\end{substStack}

\begin{substCntr}[Update the stack counter]\label{substCntr}
For any expressions $ \expressionsWp_1, \expressionsWp_2 $ 
if we have that the states $s_1$ and $s_2$ are such that
 $s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and 
$s_2 =  \config{\heap}{\evalExp{ \expressionsWp_2}{ s_1  } }{ \stackOnly }{\locVarOnly}{\pc }  $ then 
the following holds:
\begin{enumerate}
      \item $\evalExp{\substitution{\expressionsWp_1}{ \counter }{ \expressionsWp_2 }}{ s_1 } = \evalExp{\expressionsWp_1}{s_2} $
      \item $\interp{\substitution{\psi}{ \counter }{ \expressionsWp_2 }}{ s_1 } \iff \interp{\psi}{s_2} $
\end{enumerate}
\end{substCntr} 




\begin{substRet}[Return value property]\label{substRet} 
For any expression $\expressionsWp_1$ and $\expressionsWp_2$,
for any two states $s_1$ and $s_2$  such that
$ s_1 =   \config{\heap}{\counterOnly}{ \stackOnly }{\locVarOnly}{\pc }$ and \\
$ s_2 =   \configFinalNorm{\heap}{\locVarOnly}{\evalExp{\expressionsWp_2}{s_1} } $ then 
the following holds:
\begin{enumerate}
      \item $\evalExp{\substitution{\expressionsWp_1}{ \result }{ \expressionsWp_2 }}{ s_1 } = \evalExp{\expressionsWp_1}{s_2} $
      \item $\interp{\substitution{\psi}{ \result}{ \expressionsWp_2 }}{ s_1 } \iff \interp{\psi}{s_2} $
\end{enumerate}
\end{substRet}


The next definition defines a particular set of assertion formulas which we call valid formulas.
\begin{valid}[Valid formulas]
  If an assertion formula  $ f \in \predWp $ holds in any current state and any initial state, i.e.
$\forall state, state_{init}, \interp{f}{state} $ we say that this is a valid formula and we note it with :
  $\validFormula{f} $ 
\end{valid}

% In the following, we adopt a lighter notation for the update  configuration expressions of the form:

%  $$\substitution{ state }{ E }{ \interp{\exprWp}{ state  }  }   , \ E \in \{ \heap, \counterOnly, \stackOnly, \locVarOnly, \pc \} $$
% and instead, we write 
% $$\substitution{ state }{ E }{ \exprWp }$$



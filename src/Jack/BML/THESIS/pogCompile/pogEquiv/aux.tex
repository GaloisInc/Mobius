

%\newtheorem{interProp}{Lemma} % states that the postcondition doesnot change by adding a goto
\newtheorem{wpExprSrc}{Lemma}[section]
\newtheorem{exprValueOnStack1}[wpExprSrc]{Lemma}
\newtheorem{exprSrcBcWp1}[wpExprSrc]{Lemma}
\newtheorem{exprSrcBcWp2}[wpExprSrc]{Lemma}
\newtheorem{wpStmtBcSrc1}[wpExprSrc]{Lemma}
\newtheorem{wpStmtBcSrc3}[wpExprSrc]{Lemma} % wp(s), where [s, stmt, e] does not contain stack expressions if inter(s, e) does not contain
\newtheorem{wpStmtBcSrc2}[wpExprSrc]{Lemma}
\newtheorem{theorem}{Theorem}[section]
%\newtheorem{stackCounter}[interProp]{Lemma}
%\newtheorem{dupProp}[interProp]{Lemma}
%\newtheorem{newProp}[interProp]{Lemma}


\section{Proof obligation equivalence on source and bytecode level}\label{pogEq:aux}

In the following, we will argue that the proof obligations generated by the weakest precondition
over programs of our source language are equivalent to the  proof obligations generated over bytecode.

First, we remark that a $\wpNameSrcExpr$ defined over source  expressions generates formulas which may
 have two possible normal forms. From the definition of the \wpName{}  for expressions, we may notice that the predicate 
$\wpSrcExpr{\expressionSrc }{ \psi }{ \excPost}{v}$ asserts that  (in case for normal termination) the  normal postcondition
 predicate $\psi $ must hold under certain  conditions in the prestate of the evaluation of an expression and that
 (in the exceptional termination case) some other condition must hold. Some expressions always terminate evaluation normally
 (e.g. constants, \instanceof{} expressions) and in that case for normalizing the form of the \wpName{} result we may consider
that the exceptional postcondition case is equal to \Mytrue. Another particularity is that th instance creation
expression has a \wpName{} predicate which is quantified over the evaluation of the new instance. The same happens in the case
for method invokation expressions where the \wpName{} predicate is quantified over the result of the method invokation 
as well on the values of the modified expressions by the method invokation. 
Thus, we obtain the following formal statement.
 

\begin{wpExprSrc}[Normal form of $\wpNameSrcExpr$] \label{pogEq:aux:wpExprSrc}
for any source expression $\expressionSrc$ 
normal form of  $\wpNameSrcExpr$ is such that 

$$ \begin{array}{l}
         \mbox{\rm\textit{either  there exists $ Q,R:\formulaSrc $  }} \\
         \wpSrcExpr{\expressionSrc }{ \psi }{ \excPost}{v} \  = \\ 
          Q \Rightarrow \psi \\
          \wedge \\ 
	  R \\\\
	  \mbox{\rm\textit{or exists $ Q,R:\formulaSrc, v_1 \ldots v_k :\expressionSrc $   }} \\
\\
 \wpSrcExpr{\expressionSrc }{ \psi }{ \excPost}{v} \  = \\
      \forall \freshVar, \freshVar_1, \ldots  \freshVar_k   ,  Q \Rightarrow \psi 
                                                                             \begin{array}{l}
									         \subst{v}{ \freshVar}  \\
									        \subst{v_1 }{ \freshVar_1 }  \\
										\ldots \\
										\subst{v_k}{ \freshVar_k } 
									     \end{array}
          \wedge \\ 
	  R  
   \end{array}  $$ \\
\end{wpExprSrc}

This follows from the definition of $\wpNameSrcExpr$ \ in Section \ref{pog:wpSrc:wpExpr}.% The second form  in which the part of the calculated weakest precondition predicate is quantified   appears in the cases for instance creation and method invokation expressions.

%Before stating the main theorem we need some auxiliary properties.
% First, we establish that adding a \instr{goto} \ instruction  to a bytecode of instructions does not change the weakest predicate of the
% augmented bytecode sequence.  


%\begin{interProp} \label{interProp}
%Assume that we have the block of bytecode instructions $i_1;...;i_k$ 
%     $$ \wpBcSeq{ i_1;...;i_k}{ \psi  }  { \excPost } = 
%\wpBcSeq{i_1;...;i_k; \goto \  l }{\psi }{\excPost} $$
%
%The proof is based on the fact that the instruction \goto \ does not have side effects and thus,
%the following holds: $ \wpBcSeq{ \instr{goto l}}{\psi}{\excPost} = \psi $
%\end{interProp}


We now turn to see what is the relation between  the weakest precondition formulas \ for  an expression $\expressionSrc$ 
and its compilation $\compileLabel{s}{\expressionSrc}{e}$. 
Depending on the form of the weakest precondition  (as we saw with the previous lemma there are two possible forms of the weakest precondition for source expressions) 
of a soure expression $\expressionSrc $ obtained from  $\wpNameSrcExpr$ 
 we will state the relation between $\wpNameSrcExpr$  \ and $\wpNameBcSeq$  in the following two lemmas.  
Informally, both lemmas express the fact that 
\begin{itemize}
  \item the hypothesis of the part of the weakest preconditions on  source and bytecode level
concerning the normal termination of the expression  are the same  
   \item   the part of the weakest preconditions on  source and bytecode level concerning the exceptional termination 
           of the expression are the same  
\end{itemize}



\begin{exprSrcBcWp1}[Wp of a compiled expression ] \label{exprValueOnStack}
 For any expression $\expressionSrc$ from our source language, for any formula $\psi: \formulaSrc$  
of the source assertion language and any formula $\phi: \formulaBc$ such that $\phi$ may only 
contain stack expressions of the form     $\stack{\counter - k}, k \ge 0$, the following holds



  There  exist $ Q, R : \formulaSrc$  such that 
$$ \begin{array}{l}
      \wpSrcExpr{\expressionSrc }{ \psi }{ \excPost}{v} \  = \\ 
          Q \Rightarrow \psi \\
          \wedge \\ 
	  R  \\
  \\
\Longrightarrow \\
 \\

  
	    \wpBcSeq{ \compileLabel{s}{\expressionSrc}{e} }{ \phi }{\excPost} \  = \\ 
              Q \Rightarrow \phi \begin{array}{l}
                                       \subst{\counter}{\counter + 1}\\
			               \subst{\stack{\counter +1}}{ v }
                         \end{array} \\ \\
          \wedge \\ 
	  R 
  \end{array}$$

\end{exprSrcBcWp1}


The following lemma refers to the cases for method invokation and instance creation. 
\begin{exprSrcBcWp2}[Wp of a compiled expression ] \label{pogEq:aux:exprSrcBcWp}
\todo{actually, here need an assumption that the modifies clauses cannot contain stack expressions }
 For any expression $\expressionSrc$ from our source language, for any formula $\psi: \formulaSrc$  
of the source assertion language and any formula $\phi: \formulaBc$ such that $\phi$ may only 
contain stack expressions of the form     $\stack{\counter - k}, k \ge 0$ and if the modifies clauses of every
 method does not contain stack expressions, then the following holds : \\
there exist $ Q,R:\formulaSrc, v_1 \ldots v_k :\expressionSrc $
$$ \begin{array}{l} \wpSrcExpr{\expressionSrc }{ \psi }{ \excPost}{v} = \\
 \forall \freshVar, \freshVar_1, \ldots  \freshVar_k   ,  Q \Rightarrow \\
 \Myspace \psi 
                                                                             \begin{array}{l}
									         \subst{v }{ \freshVar }  \\
									        \subst{v_1 }{ \freshVar_1 }  \\
										\ldots \\
										\subst{v_k}{ \freshVar_k } 
									     \end{array}
          \wedge \\ 
	  R  

      
  \\
 \Longrightarrow \\
 \\

  
	    \wpBcSeq{ \compileLabel{s}{\expressionSrc}{e} }{ \phi }{\excPost} \  = \\ 
            \forall \freshVar, \freshVar_1, \ldots  \freshVar_k ,   Q \Rightarrow \\
	                      \Myspace \phi \begin{array}{l}
                                       \subst{\counter}{\counter + 1}\\
			               \subst{\stack{\counter +1}}{\freshVar  }\\
				       \subst{v_1 }{ \freshVar_1 }  \\
				       \ldots \\
				       \subst{v_k}{ \freshVar_k } 
                         \end{array} \\ \\
          \wedge \\ 
	  R 
  \end{array}$$
\end{exprSrcBcWp2}


The next lemma establishes  a relation between the source and bytecode functions \wpName \ w.r.t. to the same weakest precondition. 

\todo{say here that we are aware that the names on bytecode and source level will not be the same. However this is a minor detail }
\begin{wpStmtBcSrc1}[Proof obligation equivalence on statements ] \label{wpStmtBcSrc1}
 
$$ 
    \begin{array}{l}
    \forall \stmt, \psi, \excPostSrc , \\
       \Myspace  \wpStmt{\compileLabel{s}{\stmt}{e}}{ \psi }{ \excPostSrc }  = \\
       \Myspace   \wpSrcStmt{\stmt  }{\psi }{ \excPostSrc }  
	 
    \end{array}
 $$
\end{wpStmtBcSrc1}

This follows from the previous lemma (which establishes the relation between the \wpName \ over source expressions and
 the \wpName \ over bytecode expressions that takes into account the compilation structure  )
and is done by structural induction. Note that it is trivial as the \wpName{} for the compilation of statements  into bytecode  introduced in Section 
is very similar to the \wpName{} for source statements. 


 

%\todo{say what is this?}
 
%\begin{wpStmtBcSrc3}  \label{wpStmtBcSrc3}
%For every $\stmt$, compilation $\compileLabel{s}{\stmt}{e}$ 
%$ \wpi{}{\methodd}{\ins{s} } $ does not contain stack expressions
%\end{wpStmtBcSrc3}

The next statement establishes under what conditions
 the \wpName \  over source and the \wpName \ defined in the previous Chapter are equivalent.

\begin{wpStmtBcSrc2}[Proof obligation equivalence on statements] \label{wpStmtBcSrc2}
For every $\stmt$, compilation $\compileLabel{s}{\stmt}{e}$,  formula $\psi$ and 
   exceptional postcondition  function $\excPostExpl $ such that :
 
  \begin{itemize}
         \item $\psi = \inter{e}{e+1}$
	 \item$\forall \mbox{\rm\texttt{Exc}} ,  \excPostExpl( \mbox{\rm\texttt{Exc}} ) = \methodd.\getExcPost(\mbox{\rm\texttt{Exc}}, e) $ 
  \end{itemize}
      then it holds 
$$ \wpSrcStmt{\stmt}{\psi }{\excPostSrc }  = \wpi{}{\methodd}{\ins{s} }$$
\end{wpStmtBcSrc2}
\textit{Proof}: \\
This follows from Lemma \ref{wpStmtBcSrc1} and Lemma \ref{relWpStmt} \\
\Qed


From the last lemma follows that if the body of the  method \methodd \ is $\stmt$, and its compilation is $\compileLabel{s}{\stmt}{e}$, then 
the proof obligations generated over $\stmt$ upon postcondition $\method.\normalPost$ and exceptional
postcondition function  $\method.\excPostSpec$     and its compilation $\compileLabel{s}{\stmt}{e}$ are the same. The last theorem 
formalizes this fact.

\begin{theorem}[Proof obligation preservation]
For all method \methodd \ if its body is $\stmt$ such that its compilation is 
 $\compileLabel{s}{\stmt}{e}$  we have the following:
$$ \wpSrcStmt{\stmt}{\methodd.\normalPost }{\methodd.\excPostSrc }  = \wpi{}{\methodd}{\ins{s} }$$
\end{theorem}
The proof follows from the previous proposition \ref{wpStmtBcSrc2}




Note that such an equivalence between proof obligations on source and bytecode and the fact that
we have proof for the soundness of the bytecode verification condition generator
 gives us the soundness of the source  weakest precondition calculus.  


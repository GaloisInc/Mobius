/*
 * @title       "Umbra"
 * @description "An editor for the Java bytecode and BML specifications"
 * @copyright   "(c) 2007-2008 University of Warsaw"
 * @license     "All rights reserved. This program and the accompanying
 *               materials are made available under the terms of the LGPL
 *               licence see LICENCE.txt file"
 */
package umbra.instructions;

/**
 * This class is the part of the byte code instruction parser which contributes
 * the parsing of various type representations.
 *
 * @author Aleksy Schubert (alx@mimuw.edu.pl)
 * @version a-01
 */
public class InstructionTypeParser extends InstructionNameParser {


  /**
   * This constructor sets the string to be parsed and resets the parser
   * so that it is ready to analyse the content. It relies on the
   * work in the superclass.
   *
   * @param a_line the line with the content to parse
   */
  protected InstructionTypeParser(final String a_line) {
    super(a_line);
  }

  /**
   * This method swallows a filed type descriptor. This method may not
   * advance the index in case the first character to be analysed is not the
   * proper first character of an array descriptor. We assume the string is not
   * finished before the method is called.
   *
   * As JVMS, 4.3.3 Method Descriptors says, a filed type descriptor is
   * a series of characters generated by the grammar:
   * <pre>
   * FiledType:
   *   BaseType
   *   ArrayType
   *   ObjectType ;
   * </pre>
   *
   * @return <code>true</code> when a return descriptor is successfully
   *   swallowed, <code>false</code> otherwise
   */
  public boolean swallowFieldType() {
    final String line = getLine();
    final int index = getIndex();
    boolean res = false;
    if (InstructionParserHelper.isBaseTypeDescriptor(
                        line.charAt(index))) {
      incIndex();
      res = true;
    } else {
      res =  swallowRefTypeDescriptor();
    }
    return res;
  }

  /**
   * This method swallows a reference type descriptor. This method may not
   * advance the index in case the first character to be analysed is not the
   * proper first character of an array descriptor. We assume the string is not
   * finished before the method is called.
   *
   * As JVMS, 4.3.3 Method Descriptors says, a filed type descriptor is
   * a series of characters generated by the grammar:
   * <pre>
   * FiledType:
   *   BaseType
   *   ArrayType
   *   ObjectType ;
   * </pre>
   * We omit here the BaseType case.
   *
   * @return <code>true</code> when a parameter descriptor is successfully
   *   swallowed, <code>false</code> otherwise
   */
  protected boolean swallowRefTypeDescriptor() {
    final String line = getLine();
    final int index = getIndex();
    if (InstructionParserHelper.isArrayTypeDescriptor(
                    line.charAt(index))) {
      incIndex();
      return swallowArrayTypeDescriptor();
    }
    if (InstructionParserHelper.isObjectTypeDescriptor(
                    line.charAt(index))) {
      incIndex();
      final boolean res = swallowObjectTypeDescriptor();
      return res && swallowDelimiter(';');
    }
    return false;
  }

  /**
   * This method swallows an array type descriptor. This method may not
   * advance the index in case the first character to be analysed is not the
   * proper first character of an array descriptor. We assume the string is not
   * finished before the method is called.
   *
   * As JVMS, 4.3.3 Method Descriptors says, an object type descriptor is
   * a series of characters generated by the grammar:
   * <pre>
   * ArrayType:
   *   [ ComponentType ;
   * </pre>
   * we assume [ is already swallowed so we swallow here only the component
   * type.
   *
   * @return <code>true</code> when a return descriptor is successfully
   *   swallowed, <code>false</code> otherwise
   */
  private boolean swallowArrayTypeDescriptor() {
    boolean res = false;
    res = swallowFieldType(); //ComponentType :: = FieldType
    return res;
  }

  /**
   * This method swallows an object type descriptor. This method may not
   * advance the index in case the first character to be analysed is not the
   * proper first character of an object type descriptor. We assume the string
   * is not finished before the method is called.
   *
   * As JVMS, 4.3.3 Method Descriptors says, an object type descriptor is
   * a series of characters generated by the grammar:
   * <pre>
   * ObjectType:
   *   L &lt;classname&gt; ;
   * </pre>
   * we assume L is already swallowed so we swallow here only the class name.
   *
   * @return <code>true</code> when a return descriptor is successfully
   *   swallowed, <code>false</code> otherwise
   */
  private boolean swallowObjectTypeDescriptor() {
    final boolean res = swallowClassnameWithDelim('/');
    return res && swallowDelimiter(';');
  }

}
